{% extends 'base.html' %}
{% load static %}

{% block main %}

<div class="container">
    <br />
    <div class="row">
        <div class="col-md-4">
            <div id="user-list" class="list-group">
                <a href="" class="list-group-item disabled">
                    <h4 class="list-group-item-heading">My Friend</h4>
                    {# Users go here #}
                </a>
            </div>
        </div>
        <div class="col-md-8">
            {% include 'chat/chat_base.html' %}
        </div>
    </div>
</div>

<script>
    let sessionKey = '{{ request.session.session_key }}';
    let currentUser = '{{ request.user.username }}';
</script>
<script>
    let currentRecipient = '';
    let userList = $('#user-list');
    var csrftoken = '{{ csrf_token }}';

    async function updateUserList() {
        let get_message = await fetch(`friends/`)
        let data = await get_message.json()
        userList.children('.user').remove();
        for (let i = 0; i < data.length; i++) {
            const userItem = `<a class="list-group-item user" name="${data[i]['id']}" id="chat_${data[i]['id']}"  my_id="${data[i]['my_id']}">
            ${data[i]['name']}
            </a>`;
            $(userItem).appendTo('#user-list');
        }
        $('.user').click(function () {
            userList.children('.active').removeClass('active');
            let selected = event.target;
            $(selected).addClass('active');
            selected.style.color = "black"
            setCurrentRecipient(selected.name, selected.getAttribute('my_id'));
        });

    }

    async function getConversation(recipient) {
        let get_message = await fetch(`message/${recipient}`)
        let data = await get_message.json()
        messageList.children('.message').remove();
        for (let i = data.length - 1; i >= 0; i--) {
            drawMessage(data[i]);
        }
        // messageList.animate({ scrollTop: messageList.prop('scrollHeight') });

    }

    async function getMessageById(message) {
        id = JSON.parse(message).message
        let get_message = await fetch(`getmessage/${id}`)
        let data = await get_message.json()
        if (data.chat_id == currentRecipient) {
            drawMessage(data);
        } else if (document.getElementById(`chat_${data.chat_id}`)) {
            let chat = document.getElementById(`chat_${data.chat_id}`)

            chat.style.color = "red"
        }
        // messageList.animate({ scrollTop: messageList.prop('scrollHeight') });
    }

    function sendMessage(recipient, text) {
        const formData = new FormData();
        formData.append('text', text);
        formData.append('csrfmiddlewaretoken ', csrftoken);
        fetch(`message/${recipient}`, {
            method: 'POST',
            body: formData
        }).catch(err => alert("Error Message Not Sent"))
    }

    function setCurrentRecipient(username, my_id) {
        currentRecipient = username;
        currentUser = my_id
        getConversation(currentRecipient);
        enableInput();
    }


    function enableInput() {
        chatInput.prop('disabled', false);
        chatButton.prop('disabled', false);
        chatInput.focus();
    }

    function disableInput() {
        chatInput.prop('disabled', true);
        chatButton.prop('disabled', true);
    }

    $(document).ready(function () {
        updateUserList();
        disableInput();

        //    let socket = new WebSocket(`ws://127.0.0.1:8000/?session_key=${sessionKey}`);
        var socket = new WebSocket(
            'ws://' + window.location.host +
            `/ws?session_key=${sessionKey}`)

        chatInput.keypress(function (e) {
            if (e.keyCode == 13)
                chatButton.click();
        });

        chatButton.click(function () {
            if (chatInput.val().length > 0) {
                sendMessage(currentRecipient, chatInput.val());
                chatInput.val('');
            }
        });

        socket.onmessage = function (e) {
            getMessageById(e.data);
        };
    });
</script>

{% endblock %}