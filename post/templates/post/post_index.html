{% extends 'base.html' %}

{% block main %}

<div class='container'>

    <div class="card m-1">
        <form action="{% url 'create_post' %}" method="POST">
            {% csrf_token %}
            <div class="card-body">
                <div class="form-group">
                    <label>Let's update your status!</label>
                    {{ form.text }}
                    <small class="form-text text-muted"> {{form.text.errors}} </small>
                </div>
                <div class="form-group row">
                    <div class="col-1">
                        <button type="submit" class="btn btn-primary">Post</button>
                    </div>
                </div>
            </div>
        </form>
    </div>

    {% for post in posts %}
    <div class="card m-1 bg-info" id="post_{{post.id}}">
        <div class="card-body">

            <div>‡πÇ‡∏û‡∏™‡πÄ‡∏°‡∏∑‡πà‡∏≠ {{post.time}}</div>
            <h5 class="card-title">{{post.createBy.name}}</h5>
            <h6 class="card-text">{{post.text}}</h6>
            <div class="btn-group mr-2" role="group" aria-label="First group">
                <button type="submit" class="btn btn-secondary" onclick="emotion_post({{post.id}}, 1, this)">üëç<span
                        class="like">{{post.like}}</span></button>
                <button type="submit" class="btn btn-secondary" onclick="emotion_post({{post.id}}, 2, this)">üòÇ<span
                        class="haha">{{post.haha}}</span></button>
                <button type="submit" class="btn btn-secondary" onclick="emotion_post({{post.id}}, 3, this)">üò†<span
                        class="angry">{{post.angry}}</span></button>
                <button type="submit" class="btn btn-secondary" onclick="emotion_post({{post.id}}, 4, this)">üò≠<span
                        class="sad">{{post.sad}}</span></button>
            </div>
            <!-- </form> -->

            <a href="{% url 'view_post' post.id %}" class="card-link">View</a>
            <a onclick="distribute()" class="card-link">Distribute {{post.numberOfDistribution}}</a>
            <a href="{% url 'delete_post' post.id %}" class="card-link">Delete</a>
            <a href="{% url 'edit_post' post.id %}" class="card-link">Edit</a>



            <!-- {% comment %} {% include 'comment/comment.html'%}  {% endcomment %} -->



            {% for comment in post.getComment %}
            <div class="card m-1" id="comment_{{comment.id}}">
                <div class="card-body">
                    <h6>{{comment.text}}</h6>
                    <div class="btn-group mr-2" role="group" aria-label="First group">
                        <button type="submit" class="btn btn-secondary"
                            onclick="emotion_comment({{comment.id}}, 1, this)">üëç<span
                                class="like">{{comment.like}}</span></button>
                        <button type="submit" class="btn btn-secondary"
                            onclick="emotion_comment({{comment.id}}, 2, this)">üòÇ<span
                                class="haha">{{comment.haha}}</span></button>
                        <button type="submit" class="btn btn-secondary"
                            onclick="emotion_comment({{comment.id}}, 3, this)">üò†<span
                                class="angry">{{comment.angry}}</span></button>
                        <button type="submit" class="btn btn-secondary"
                            onclick="emotion_comment({{comment.id}}, 4, this)">üò≠<span
                                class="sad">{{comment.sad}}</span></button>
                    </div>
                </div>
            </div>
            {% endfor %}



            <form action="{% url 'addComment' post.id %}" method="POST">
                {% csrf_token %}
                <div class="card-body">
                    <div class="form-group">
                        <label>Let's comment the POST!</label>
                        {{ form.text }}
                        <small class="form-text text-muted"> {{form.text.errors}} </small>
                    </div>
                    <div class="form-group row">
                        <div class="col-1">
                            <button type="submit" class="btn btn-primary">Comment</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        var chatSocket = new WebSocket(
            'ws://' + window.location.host +
            '/ws/post/post' + "{{post.id}}" + '/');
        chatSocket.onmessage = function (e) {
            var data = JSON.parse(e.data).message;
            console.log(data)

            if (data.comment) {
                var element = document.getElementById("comment_" + data.comment)
            } else {
                var element = document.getElementById("post_{{post.id}}")
            }
            console.log(element)
            if (data.like) {
                var like = element.getElementsByClassName("like")[0]
                like.innerText = data.like
            }
            else if (data.haha) {
                var haha = element.getElementsByClassName("haha")[0]
                haha.innerText = data.haha
            }
            else if (data.angry) {
                var angry = element.getElementsByClassName("angry")[0]
                angry.innerText = data.angry
            }
            else if (data.sad) {
                var sad = element.getElementsByClassName("sad")[0]
                sad.innerText = data.sad
            }

        };

        chatSocket.onclose = function (e) {
            console.error('Chat socket closed unexpectedly');
        };
    </script>
    {% endfor %}

</div>

<script>


    var baseUrl = window.location.protocol + "//" + window.location.host
    async function emotion_post(post, type, element) {
        fetch(baseUrl + `/post/emotion/${post}/${type}`, {
            method: 'POST'
        })
            // .then(res => console.log(res))
            .catch(err => alert(err))
    }

    async function emotion_comment(comment, type, element) {
        fetch(baseUrl + `/comment/emotion/${comment}/${type}`, {
            method: 'POST'
        })
            // .then(res => console.log(res))
            .catch(err => alert(err))
    }


    // function distribute() {
    //     const data = { numberOfDistribution: 1 };

    //     var url = 'http://127.0.0.1:8000/post/api/post/';
    //     var data = { numberOfDistribution: 1 };
    //     fetch(url, {
    //         method: 'POST', // or 'PUT'
    //         body: JSON.stringify(data), // data can be `string` or {object}!
    //         headers: {
    //             'Content-Type': 'application/json'
    //         }
    //     }).then(res => res.json())
    //         .then(response => console.log('Success:', JSON.stringify(response)))
    //         .catch(error => console.error('Error:', error));
    // }
</script>

{% endblock main %}